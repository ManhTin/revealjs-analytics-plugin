const e="INTERNAL",t="EXTERNAL",n="AUDIO",i="VIDEO",o="PLAY",s="PAUSE",r="START",l="COMPLETE",a={apiConfig:{},dwellTimes:!0,links:!0,media:!0,slideTransitions:!0,revealDependencies:{quiz:!1},optOut:{popupDelay:1e3},debug:!1};class c{constructor(e={}){this.config={popupDelay:1e3,...e},this.popup=null,this.trackingAllowed=!0,this.initialized=!1}init(){return this.initialized||(setTimeout((()=>this.showPopup()),this.config.popupDelay),this.initialized=!0),this.trackingAllowed}showPopup(){this.popup=document.createElement("div"),this.popup.className="reveal-analytics-popup",this.popup.innerHTML='\n      <span class="reveal-tracking-close">&times;</span>\n      <p>This presentation uses analytics to improve content. No personal data is collected.</p>\n      <div class="reveal-analytics-buttons">\n        <button class="reveal-analytics-btn reveal-tracking-decline">Opt Out</button>\n        <button class="reveal-analytics-btn reveal-tracking-accept">Accept</button>\n      </div>\n    ',this.popup.querySelector(".reveal-tracking-close").addEventListener("click",(()=>{this.acceptTracking()})),this.popup.querySelector(".reveal-tracking-accept").addEventListener("click",(()=>{this.acceptTracking()})),this.popup.querySelector(".reveal-tracking-decline").addEventListener("click",(()=>{console.log("Opting out of tracking"),this.optOut()})),document.body.appendChild(this.popup)}acceptTracking(){this.trackingAllowed=!0,this.closePopup()}optOut(){this.trackingAllowed=!1,this.closePopup()}closePopup(){this.popup?.parentNode&&(this.popup.parentNode.removeChild(this.popup),this.popup=null)}isTrackingAllowed(){return this.trackingAllowed}}
/*!
 * reveal-analytics plugin v1.0.0
 * Manh Tin Nguyen
 * MIT licensed
 *
 * Copyright (C) 2025 Manh Tin Nguyen
 */class d{constructor(){this.seconds=0}start(){this.timer?console.log("The timer is already running."):this.timer=setInterval((()=>{this.seconds++}),1e3)}reset(){this.clear(),this.start()}clear(){this.timer&&(clearInterval(this.timer),this.timer=void 0),this.seconds=0}getTime(){return this.seconds}toString(){const e=Math.floor(this.seconds/3600),t=Math.floor(this.seconds%3600/60),n=this.seconds%60;return`${e>9?e:`0${e}`}:${t>9?t:`0${t}`}:${n>9?n:`0${n}`}`}}const p=e=>Reveal.getSlides().indexOf(e)+1,u=e=>!0===e.dwellTimes||e.dwellTimes.total,g=e=>!0===e.dwellTimes||e.dwellTimes.perSlide,v=e=>!0===e.links||e.links.internal,h=e=>!0===e.links||e.links.external,m=e=>!0===e.media||e.media.audio,f=e=>!0===e.media||e.media.video,w=(e,t)=>{if(!m(e)&&!f(e))return;const r=()=>{const r=(e=>document.querySelectorAll(m(e)&&f(e)?"audio, video":m(e)?"audio":"video"))(e);for(const l of r){const r={mediaId:l.id,mediaType:"AUDIO"===l.tagName?n:i,presentationId:e.apiConfig.presentationId,presentationUrl:window.location.href.replace(/(#(.+)?)/,"")};l.onplay||(l.onplay=function(){const n=Reveal.getCurrentSlide(),i=p(n);t.push({timestamp:(new Date).toISOString(),actionType:o,slideNumber:i,mediaSource:this.currentSrc,currentTime:Number.parseInt(this.currentTime,10),totalDuration:Number.parseInt(this.duration,10),...r}),console.log("logMediaActionEvent:",t.slice(-1)[0]),e.debug&&console.log("ðŸš€ Media played:",t)}),l.onpause||(l.onpause=function(){const e=Reveal.getCurrentSlide(),n=p(e);t.push({timestamp:(new Date).toISOString(),actionType:s,slideNumber:n,mediaSource:this.currentSrc,currentTime:Number.parseInt(this.currentTime,10),totalDuration:Number.parseInt(this.duration,10),progress:this.currentTime/this.duration,finished:this.ended,...r}),console.log("logMediaActionEvent:",t.slice(-1)[0])})}};Reveal.addEventListener("ready",r),Reveal.addEventListener("fragmentshown",r),Reveal.addEventListener("fragmenthidden",r),Reveal.addEventListener("slidechanged",r)},S=()=>{const n={...a,...Reveal.getConfig().revealAnalytics},i={logPresentationStartEvents:[],logPresentationCloseEvents:[],logSlideViewEvents:[],logLinkActionEvents:[],logMediaActionEvents:[],logQuizActionEvents:[]},o=new c(n.optOut);if(!n.apiConfig.trackingAPI)return console.error("You have no trackingAPI configured where to send tracking data to!"),null;const s=new d,m=new d,f=()=>{((e,t)=>{Reveal.on("ready",(n=>{const i=Reveal.getCurrentSlide();t.push({presentationId:e.apiConfig.presentationId,presentationUrl:window.location.href.replace(/(#(.+)?)/,""),timestamp:(new Date).toISOString(),slideNumber:p(i)}),console.log("logPresentationStartEvent:",t.slice(-1)[0])}))})(n,i.logPresentationStartEvents),((e,t,n)=>{g(e)&&Reveal.addEventListener("slidechanged",(i=>{i.previousSlide&&(t.push({presentationId:e.apiConfig.presentationId,presentationUrl:window.location.href.replace(/(#(.+)?)/,""),timestamp:(new Date).toISOString(),slideNumber:p(i.previousSlide),dwellTime:n.getTime()}),n.reset(),console.log("logSlideViewEvent:",t.slice(-1)[0]))}))})(n,i.logSlideViewEvents,m),((e,{logPresentationStartEvents:t,logPresentationCloseEvents:n,logSlideViewEvents:i,logLinkActionEvents:o,logMediaActionEvents:s,logQuizActionEvents:r},l,a)=>{window.addEventListener("beforeunload",(c=>{const d=Reveal.getCurrentSlide(),g=window.location.href.replace(/(#(.+)?)/,"");n.push({presentationId:e.apiConfig.presentationId,presentationUrl:g,slideNumber:p(d),timestamp:(new Date).toISOString(),finalProgress:Reveal.getProgress(),totalDwellTime:u(e)?l.getTime():null}),console.log("logPresentationCloseEvent:",n.slice(-1)[0]);const v={logPresentationStartEvents:t,logPresentationCloseEvents:n,logSlideViewEvents:i,logLinkActionEvents:o,logMediaActionEvents:s,logQuizActionEvents:r};a.isTrackingAllowed()&&(e.debug&&console.log("ðŸš€ ~ sending events:",v),navigator.sendBeacon(e.apiConfig.trackingAPI,JSON.stringify(v))),c.preventDefault()}))})(n,i,s,o),((n,i)=>{(v(n)||h(n))&&document.addEventListener("click",(o=>{const s=Reveal.getCurrentSlide();if(!Array.from(s.querySelectorAll("a")).includes(o.target))return;const r=window.location.href.replace(new RegExp(window.location.hash)||"",""),l=o.target.href.replace(r,""),a=l.startsWith("#");if(a&&v(n)||!a&&h(n)){const r=a?e:t,c=a?l:o.target.href;i.push({presentationId:n.apiConfig.presentationId,presentationUrl:window.location.href.replace(/(#(.+)?)/,""),timestamp:(new Date).toISOString(),slideNumber:p(s),linkType:r,linkUrl:c,linkText:o.target.text.trim()}),console.log("logLinkActionEvent",i.slice(-1)[0])}}))})(n,i.logLinkActionEvents),w(n,i.logMediaActionEvents),((e,t)=>{if(!e.revealDependencies.quiz)return;const n={},i=Reveal.getConfig().quiz||{};i.events=i.events||{};const o=()=>{const i=Reveal.getCurrentSlide(),o=i.querySelector("[data-quiz]");if(!o)return!0;const s=o.dataset.quiz,l=window[s];if(!l)return!0;n[s]instanceof d?n[s].reset():(n[s]=new d,n[s].start());const a={quizId:s,quizName:l.info.name,numberOfQuestions:l.questions.length,presentationId:e.apiConfig.presentationId,presentationUrl:window.location.href.replace(/(#(.+)?)/,"")};return t.push({timestamp:(new Date).toISOString(),slideNumber:p(i),actionType:r,...a}),console.log("logQuizActionEvent:",t.slice(-1)[0]),!0},s=i=>{const o=Reveal.getCurrentSlide(),s=o.querySelector("[data-quiz]");if(!s)return!0;const r=s.dataset.quiz,a=window[r];if(!a)return!0;let c;n[r]instanceof d&&(c=n[r].getTime(),n[r].clear());const u={quizId:r,quizName:a.info.name,numberOfQuestions:a.questions.length,presentationId:e.apiConfig.presentationId,presentationUrl:window.location.href.replace(/(#(.+)?)/,"")};return t.push({timestamp:(new Date).toISOString(),actionType:l,slideNumber:p(o),dwellTime:c,completed:!0,score:i.score/a.questions.length,...u}),console.log("logQuizActionEvent:",t.slice(-1)[0]),!0};if(i.events.onStartQuiz){const e=i.events.onStartQuiz;i.events.onStartQuiz=()=>{o(),e()}}else i.events.onStartQuiz=o;if(i.events.onCompleteQuiz){const e=i.events.onCompleteQuiz;i.events.onCompleteQuiz=t=>{s(t),e(t)}}else i.events.onCompleteQuiz=s;"function"==typeof prepareQuizzes&&prepareQuizzes(i)})(n,i.logQuizActionEvents)};return{id:"reveal-analytics",init:()=>{n.optOut&&function(){const e=document.createElement("link");e.rel="stylesheet",e.type="text/css",e.href="plugin/reveal-analytics/css/opt-out.css",document.head.appendChild(e),o.init()}(),f(),s.start(),g(n)&&m.start(),n.debug&&(console.log("Initialized reveal-analytics plugin"),console.log("Plugin Config:",n),console.log("Tracking allowed:",o.isTrackingAllowed()))}}};export{S as default};
